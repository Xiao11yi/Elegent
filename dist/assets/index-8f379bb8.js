import{_ as U,y as D,r as w,z as J,u as V,C as N,o as z,B as A,a2 as M,a as F,b as n,c,f as d,w as _,ai as P,d as h,F as W,e as j,n as G,k as y,t as v,i as b,S as $,a3 as H,al as K,ak as L,V as Q}from"./index-08731fde.js";import{g as T}from"./chat-4cb3b98c.js";const X={class:"chat-layout"},Y=["onClick"],Z={style:{float:"left"}},ee={key:0,style:{float:"left",width:"115px","margin-left":"8px",height:"25px",display:"inline-block",overflow:"hidden","text-overflow":"ellipsis","font-weight":"700"}},te={key:1,style:{float:"left",width:"115px","margin-left":"8px",height:"25px",display:"inline-block",overflow:"hidden","text-overflow":"ellipsis","font-weight":"700"}},ae={style:{float:"right",width:"143px",height:"25px","line-height":"25px","text-align":"right"}},se={style:{float:"left",width:"230px",display:"inline-block",overflow:"hidden","text-overflow":"ellipsis","margin-left":"8px",height:"25px"}},oe={__name:"index",setup(le){const r=D(),l=w(""),p=J(),S=V(),o=w([]),k=w(0),x=()=>r.state.user.id;l.value=x(),N(()=>x(),t=>{l.value=t},{immediate:!0,deep:!0});const f=(t,e)=>{k.value=e,S.push({path:"/chat/list",query:{id:t,chatName:o.value[e].to_id===l.value?o.value[e].from_user_name:o.value[e].to_user_name,toId:o.value[e].to_id===l.value?o.value[e].from_id:o.value[e].to_id,time:Date.now()}}),o.value[e].countRead=0},R=(t,e)=>t.some(a=>Number(a.to_id)===e||Number(a.from_id)===e?(f(a.chat_id,t.indexOf(a)),!0):!1),O=(t,e)=>{if(t.query.allData){let a=decodeURIComponent(t.query.allData);const i=JSON.parse(a);if(!R(e.value,i.user_id)){const m={to_avatar:i.avatar,to_id:i.user_id,to_user_name:i.user_name,create_time:new Date};localStorage.setItem("newChat",JSON.stringify(m)),e.value.unshift(JSON.parse(localStorage.getItem("newChat"))),f(e.value[0].chat_id,0)}}else JSON.parse(localStorage.getItem("newChat"))&&e.value.unshift(JSON.parse(localStorage.getItem("newChat")))},I=async()=>{try{const t=await T(),e=p.query.toId;e&&t.data.some(a=>{(Number(a.to_id)===Number(e)||Number(a.from_id)===Number(e))&&(a.countRead=0)}),o.value=t.data,O(p,o)}catch{}};z(async()=>{await r.dispatch("GetUserId"),l.value=r.state.user.id,await I(),r.dispatch("connectWebSocket",{userId:l.value})});const u=A(()=>r.state.webscoket.message),q=async()=>{try{u.value.message!=null&&!isNaN(u.value.message)&&u.value.message.trim()!==""&&await I()}catch{}};return N(u,(t,e)=>{q()},{immediate:!0,deep:!0}),M(()=>{r.dispatch("disconnectWebSocket")}),(t,e)=>{const a=$,i=H,C=K,m=F("router-view"),B=L,E=P;return n(),c("div",X,[d(E,null,{default:_(()=>[d(C,{width:"360px"},{default:_(()=>[h("ul",null,[(n(!0),c(W,null,j(o.value,(s,g)=>(n(),c("li",{key:g,class:G({"is-selected":k.value===g}),onClick:ne=>f(s.chat_id,g)},[h("div",Z,[d(i,{value:s.countRead==0?"":s.countRead,max:99,class:"item"},{default:_(()=>[s.to_id!==l.value?(n(),y(a,{key:0,shape:"square",size:50,src:"/dev-api"+s.to_avatar},null,8,["src"])):(n(),y(a,{key:1,shape:"square",size:50,src:"/dev-api"+s.from_avatar},null,8,["src"]))]),_:2},1032,["value"])]),s.to_id!==l.value?(n(),c("div",ee,v(s.to_user_name),1)):(n(),c("div",te,v(s.from_user_name),1)),h("div",ae,v(b(Q)(s.create_time)),1),h("div",se,v(s.latest_message),1)],10,Y))),128))])]),_:1}),d(B,null,{default:_(()=>[(n(),y(m,{key:b(p).fullPath}))]),_:1})]),_:1})])}}},ce=U(oe,[["__scopeId","data-v-162a1c87"]]);export{ce as default};
